<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.youthloop.query.mapper.CommentQueryMapper">

  <!-- 查询根评论列表（分页） -->
  <select id="selectRootComments" resultType="map">
    SELECT 
      c.id,
      c.target_type,
      c.target_id,
      c.user_id,
      p.nickname AS user_nickname,
      p.avatar_url AS user_avatar,
      c.parent_id,
      c.root_id,
      c.depth,
      c.body,
      c.status,
      c.created_at,
      c.updated_at,
      COALESCE(cs.like_count, 0) AS like_count,
      COALESCE(cs.reply_count, 0) AS reply_count
    FROM social.comment c
    LEFT JOIN shared.user_profile p ON c.user_id = p.user_id
    LEFT JOIN social.comment_stats cs ON c.id = cs.comment_id
    WHERE c.target_type = #{targetType}
      AND c.target_id = #{targetId}::uuid
      AND c.depth = 0
      AND c.status = 1
    <choose>
      <when test="sort == 'hot'">
        ORDER BY COALESCE(cs.hot_score, 0) DESC, c.created_at DESC
      </when>
      <otherwise>
        ORDER BY c.created_at DESC
      </otherwise>
    </choose>
    LIMIT #{limit} OFFSET #{offset}
  </select>

  <!-- 统计根评论总数 -->
  <select id="countRootComments" resultType="long">
    SELECT COUNT(*)
    FROM social.comment c
    WHERE c.target_type = #{targetType}
      AND c.target_id = #{targetId}::uuid
      AND c.depth = 0
      AND c.status = 1
  </select>

  <!-- 批量查询根评论的回复 -->
  <select id="selectRepliesByRootIds" resultType="map">
    WITH ranked_replies AS (
      SELECT 
        c.id,
        c.target_type,
        c.target_id,
        c.user_id,
        p.nickname AS user_nickname,
        p.avatar_url AS user_avatar,
        c.parent_id,
        c.root_id,
        c.depth,
        c.body,
        c.status,
        c.created_at,
        c.updated_at,
        COALESCE(cs.like_count, 0) AS like_count,
        COALESCE(cs.reply_count, 0) AS reply_count,
        ROW_NUMBER() OVER (PARTITION BY c.root_id ORDER BY c.created_at DESC) AS rn
      FROM social.comment c
      LEFT JOIN shared.user_profile p ON c.user_id = p.user_id
      LEFT JOIN social.comment_stats cs ON c.id = cs.comment_id
      WHERE c.root_id IN
        <foreach collection="rootIds" item="id" open="(" separator="," close=")">
          #{id}::uuid
        </foreach>
        AND c.depth &gt; 0
        AND c.status = 1
    )
    SELECT *
    FROM ranked_replies
    WHERE rn &lt;= #{limit}
    ORDER BY root_id, created_at DESC
  </select>

</mapper>
