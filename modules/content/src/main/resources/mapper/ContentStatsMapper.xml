<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.youthloop.content.persistence.mapper.ContentStatsMapper">

  <!-- Result Map -->
  <resultMap id="BaseResultMap" type="com.youthloop.content.persistence.entity.ContentStatsEntity">
    <id column="content_id" property="contentId" jdbcType="OTHER" typeHandler="org.apache.ibatis.type.UUIDTypeHandler"/>
    <result column="like_count" property="likeCount" jdbcType="INTEGER"/>
    <result column="fav_count" property="favCount" jdbcType="INTEGER"/>
    <result column="down_count" property="downCount" jdbcType="INTEGER"/>
    <result column="comment_count" property="commentCount" jdbcType="INTEGER"/>
    <result column="hot_score" property="hotScore" jdbcType="BIGINT"/>
    <result column="hot_rule_id" property="hotRuleId" jdbcType="OTHER" typeHandler="org.apache.ibatis.type.UUIDTypeHandler"/>
    <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>
  </resultMap>

  <!-- Base Column List -->
  <sql id="Base_Column_List">
    content_id, like_count, fav_count, down_count, comment_count, 
    hot_score, hot_rule_id, updated_at
  </sql>

  <!-- 根据内容 ID 查询 -->
  <select id="selectByContentId" resultMap="BaseResultMap">
    SELECT <include refid="Base_Column_List"/>
    FROM social.content_stats
    WHERE content_id = #{contentId}::uuid
  </select>

  <!-- 批量查询（用于列表） -->
  <select id="selectByContentIds" resultMap="BaseResultMap">
    SELECT <include refid="Base_Column_List"/>
    FROM social.content_stats
    WHERE content_id IN
    <foreach collection="contentIds" item="id" open="(" separator="," close=")">
      #{id}::uuid
    </foreach>
  </select>

  <!-- 插入 -->
  <insert id="insert">
    INSERT INTO social.content_stats (
      content_id, like_count, fav_count, down_count, comment_count,
      hot_score, hot_rule_id, updated_at
    ) VALUES (
      #{contentId}::uuid, #{likeCount}, #{favCount}, #{downCount}, #{commentCount},
      #{hotScore}, #{hotRuleId}::uuid, #{updatedAt}
    )
  </insert>

  <!-- 更新 -->
  <update id="update">
    UPDATE social.content_stats
    <set>
      <if test="likeCount != null">like_count = #{likeCount},</if>
      <if test="favCount != null">fav_count = #{favCount},</if>
      <if test="downCount != null">down_count = #{downCount},</if>
      <if test="commentCount != null">comment_count = #{commentCount},</if>
      <if test="hotScore != null">hot_score = #{hotScore},</if>
      <if test="hotRuleId != null">hot_rule_id = #{hotRuleId}::uuid,</if>
      updated_at = #{updatedAt}
    </set>
    WHERE content_id = #{contentId}::uuid
  </update>

</mapper>
