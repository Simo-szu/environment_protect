<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.youthloop.interaction.persistence.mapper.CommentStatsMapper">

  <!-- Result Map -->
  <resultMap id="BaseResultMap" type="com.youthloop.interaction.persistence.entity.CommentStatsEntity">
    <id column="comment_id" property="commentId" jdbcType="OTHER" typeHandler="org.apache.ibatis.type.UUIDTypeHandler"/>
    <result column="like_count" property="likeCount" jdbcType="INTEGER"/>
    <result column="down_count" property="downCount" jdbcType="INTEGER"/>
    <result column="reply_count" property="replyCount" jdbcType="INTEGER"/>
    <result column="hot_score" property="hotScore" jdbcType="BIGINT"/>
    <result column="hot_rule_id" property="hotRuleId" jdbcType="OTHER" typeHandler="org.apache.ibatis.type.UUIDTypeHandler"/>
    <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>
  </resultMap>

  <!-- 插入统计 -->
  <insert id="insert">
    INSERT INTO social.comment_stats (
      comment_id, like_count, down_count, reply_count, hot_score, hot_rule_id, updated_at
    ) VALUES (
      #{commentId}::uuid, #{likeCount}, #{downCount}, #{replyCount}, #{hotScore}, #{hotRuleId}::uuid, #{updatedAt}
    )
  </insert>

  <!-- 查询统计 -->
  <select id="selectByCommentId" resultMap="BaseResultMap">
    SELECT comment_id, like_count, down_count, reply_count, hot_score, hot_rule_id, updated_at
    FROM social.comment_stats
    WHERE comment_id = #{commentId}::uuid
  </select>

  <!-- 增加点赞数 -->
  <update id="incrementLikeCount">
    UPDATE social.comment_stats
    SET like_count = like_count + 1,
        updated_at = now()
    WHERE comment_id = #{commentId}::uuid
  </update>

  <!-- 减少点赞数 -->
  <update id="decrementLikeCount">
    UPDATE social.comment_stats
    SET like_count = GREATEST(like_count - 1, 0),
        updated_at = now()
    WHERE comment_id = #{commentId}::uuid
  </update>

  <!-- 增加踩数 -->
  <update id="incrementDownCount">
    UPDATE social.comment_stats
    SET down_count = down_count + 1,
        updated_at = now()
    WHERE comment_id = #{commentId}::uuid
  </update>

  <!-- 减少踩数 -->
  <update id="decrementDownCount">
    UPDATE social.comment_stats
    SET down_count = GREATEST(down_count - 1, 0),
        updated_at = now()
    WHERE comment_id = #{commentId}::uuid
  </update>

  <!-- 增加回复数 -->
  <update id="incrementReplyCount">
    UPDATE social.comment_stats
    SET reply_count = reply_count + 1,
        updated_at = now()
    WHERE comment_id = #{commentId}::uuid
  </update>

</mapper>
