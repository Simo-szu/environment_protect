<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.youthloop.points.persistence.mapper.ExchangeMapper">

    <resultMap id="GoodResultMap" type="com.youthloop.points.persistence.entity.GoodEntity">
        <id column="id" property="id" jdbcType="OTHER" typeHandler="com.youthloop.common.mybatis.UuidTypeHandler"/>
        <result column="title" property="title"/>
        <result column="description" property="description"/>
        <result column="image_url" property="imageUrl"/>
        <result column="points_cost" property="pointsCost"/>
        <result column="stock" property="stock"/>
        <result column="status" property="status"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <select id="selectAllActiveGoods" resultMap="GoodResultMap">
        SELECT * FROM social.exchange_good
        WHERE status = 1
        ORDER BY points_cost ASC
    </select>

    <select id="selectGoodById" resultMap="GoodResultMap">
        SELECT * FROM social.exchange_good
        WHERE id = #{id, jdbcType=OTHER, typeHandler=com.youthloop.common.mybatis.UuidTypeHandler}
    </select>

    <update id="decreaseStock">
        UPDATE social.exchange_good
        SET stock = stock - #{amount}, updated_at = now()
        WHERE id = #{id, jdbcType=OTHER, typeHandler=com.youthloop.common.mybatis.UuidTypeHandler} AND stock >= #{amount}
    </update>

    <insert id="insertOrder" parameterType="com.youthloop.points.persistence.entity.OrderEntity">
        INSERT INTO social.exchange_order (
            id, user_id, good_id, points_cost, status, 
            recipient_name, recipient_phone, shipping_address, shipping_note,
            created_at, updated_at
        ) VALUES (
            #{id, jdbcType=OTHER, typeHandler=com.youthloop.common.mybatis.UuidTypeHandler}, 
            #{userId, jdbcType=OTHER, typeHandler=com.youthloop.common.mybatis.UuidTypeHandler}, 
            #{goodId, jdbcType=OTHER, typeHandler=com.youthloop.common.mybatis.UuidTypeHandler}, 
            #{pointsCost}, #{status},
            #{recipientName}, #{recipientPhone}, #{shippingAddress}, #{shippingNote},
            #{createdAt}, #{updatedAt}
        )
    </insert>

</mapper>
